```{r}
library(tseries)
library(forecast)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(glmnet)


df <- read.csv("../Dataset/expenditure_cleaned.csv")
head(df)


df_2015 <- df %>%
  filter(Year %in% c("2015"))
country_labels <- ifelse(seq_along(df_2015$Country.Name) %% 5 == 0, df_2015$Country.Name, "")
ggplot(df_2015, aes(x = Country.Name, y = Expenditure)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  scale_x_discrete(labels = country_labels) +
  labs(title = "Health Expenditure (% of GDP) 2015",
       x = "Country",
       y = "% Health Expenditure on GDP") +
  theme_minimal()


df_top20 <- df_2015 %>%
  arrange(desc(Expenditure)) %>%
  slice(1:20)
ggplot(df_top20, aes(x = reorder(Country.Name, Expenditure), y = Expenditure)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(title = "Top 20 Country % Health Expenditure on GDP 2015", 
       x = "Country", 
       y = "% Health Expenditure on GDP 2015") +
  theme_minimal()


df_FranceItaly <- df %>%
  filter(Country.Name %in% c("France", "Italy"))

# Health Expenditure France vs Italy (% of GDP)
ggplot(df_FranceItaly, aes(x = Year, y = Expenditure, color = Country.Name)) +
  geom_line(linewidth = 1) +                         
  theme_minimal() +                            
  labs(title = "Health Expenditure France vs Italy (% of GDP)",
       x = "Year", y = "Expenditure (% of GDP)",
       color = "Country") +                      
  scale_color_manual(values = c("blue", "red"))

#Statistics
ggplot(df_2015, aes(x = Expenditure)) +
  geom_histogram(bins = 20, fill = "steelblue") +
  labs(title = "Distribution of health expenditure %")

mean(df_2015$Expenditure, na.rm = TRUE)    # Mean
median(df_2015$Expenditure, na.rm = TRUE)  # Median
var(df_2015$Expenditure, na.rm = TRUE)     # Variance
sd(df_2015$Expenditure, na.rm = TRUE)      # Standard Deviation


df_aggregated <- df %>%
  group_by(Country.Name, Year) %>%
  summarise(Expenditure = mean(Expenditure, na.rm = TRUE), .groups = 'drop')  # Aggrega i dati per paese e anno

# Passaggio 2: Trasformazione in formato wide (ogni anno diventa una colonna)
df_wide <- df_aggregated %>%
  pivot_wider(names_from = Year, values_from = Expenditure)

#ARIMA prediction

# Filtro per selezionare i dati relativi all'Italia
df_italy <- df_wide %>% filter(Country.Name == "Italy")
spesa_italia <- df_italy[, as.character(2000:2022)]
spesa_italia <- as.numeric(spesa_italia)
spesa_ts <- ts(spesa_italia, start = 2000, frequency = 1)
adf_test <- adf.test(spesa_ts)
print(adf_test)
spesa_diff <- diff(spesa_ts)
#plot(spesa_diff, main = "Serie Temporale Differenziata", ylab = "Differenza Spesa % PIL", xlab = "Anno")
arima_model <- auto.arima(spesa_diff)
summary(arima_model)
forecast_2023 <- forecast(arima_model, h = 1)
plot(forecast_2023, main = "Differences series of health expenditure (% GDP)", ylab = "Difference % PIL", xlab = "Anno")

# Stampare il valore previsto per il 2023
forecast_2023$mean

library(forecast)
library(tseries)
library(dplyr)

# Filtro per selezionare i dati relativi all'Italia
df_italy <- df_wide %>% filter(Country.Name == "Italy")
spesa_italia <- df_italy[, as.character(2000:2022)]
spesa_italia <- as.numeric(spesa_italia)

# Creazione della serie temporale
spesa_ts <- ts(spesa_italia, start = 2000, frequency = 1)

# Test ADF (facoltativo)
adf_test <- adf.test(spesa_ts)
print(adf_test)

# Costruzione del modello ARIMA direttamente sulla serie
arima_model <- auto.arima(spesa_ts)
summary(arima_model)

# Previsione per il 2023
forecast_2023 <- forecast(arima_model, h = 1)

# Plot della serie con la previsione
plot(forecast_2023, main = "Previsione Spesa Sanitaria (% PIL)", 
     ylab = "Spesa % PIL", xlab = "Anno")

# Stampare il valore previsto per il 2023
forecast_2023$mean

